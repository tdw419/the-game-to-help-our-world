<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PolyglotVoice - Mobile Speech Platform</title>
    <meta name="description" content="Mobile-optimized speech platform for AI training">
    <meta name="theme-color" content="#6366f1">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: 250ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            min-height: 100vh;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        /* Minimal Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Card System */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Text Input Area - Mobile Optimized */
        .text-area {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px; /* Prevents iOS zoom */
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
            transition: all var(--transition);
        }

        .text-area:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .text-area::placeholder {
            color: var(--text-muted);
        }

        /* Primary Action Button */
        .primary-btn {
            width: 100%;
            padding: 1.25rem 2rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .primary-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .primary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .primary-btn.active {
            background: var(--success);
            animation: activePulse 2s infinite;
        }

        @keyframes activePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .primary-btn.recording {
            background: var(--error);
            animation: recordPulse 1.5s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .quick-btn {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
        }

        .quick-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        /* Status Messages */
        .status {
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            margin: 0.5rem 0;
            transition: all var(--transition);
        }

        .status-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Voice Controls */
        .voice-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 16px; /* Prevents iOS zoom */
            background: var(--bg-primary);
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .voice-info {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius);
            padding: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Audio Visualizer */
        .visualizer {
            display: none;
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border);
            text-align: center;
        }

        .visualizer.active {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .audio-bars {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 50px;
            margin-bottom: 0.5rem;
        }

        .bar {
            width: 3px;
            background: var(--primary);
            border-radius: 2px;
            animation: audioBar 1.5s ease-in-out infinite;
        }

        .bar:nth-child(odd) { animation-delay: 0.1s; }
        .bar:nth-child(even) { animation-delay: 0.2s; }

        @keyframes audioBar {
            0%, 100% { height: 6px; }
            50% { height: 35px; }
        }

        /* Advanced Controls Toggle */
        .advanced-toggle {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            margin: 1rem 0;
            transition: all var(--transition);
        }

        .advanced-toggle:hover {
            background: var(--bg-secondary);
            border-style: solid;
        }

        .advanced-controls {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .advanced-controls.expanded {
            display: block;
        }

        .slider-group {
            margin-bottom: 1rem;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .slider-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .slider-value {
            color: var(--primary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .range-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Permission Banner - FIXED */
        .permission-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform var(--transition);
            display: none; /* Hidden by default */
        }

        .permission-banner.show {
            display: block;
            transform: translateY(0);
        }

        .permission-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 0.5rem;
            font-weight: 500;
        }

        .permission-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 2rem;
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .main-content {
                gap: 2rem;
            }

            .card {
                padding: 2rem;
            }

            .text-area {
                min-height: 150px;
                font-size: 1.1rem;
            }

            .primary-btn {
                font-size: 1.3rem;
                padding: 1.5rem 2rem;
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
                align-items: start;
            }

            .tts-section {
                grid-row: 1 / 3;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1e293b;
                --bg-secondary: #334155;
                --text-primary: #f8fafc;
                --text-secondary: #cbd5e1;
                --text-muted: #94a3b8;
                --border: #475569;
            }

            .card {
                background: rgba(30, 41, 59, 0.95);
            }
        }

        /* Print Styles */
        @media print {
            body { background: white !important; }
            .visualizer, .advanced-controls, .permission-banner { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- Permission Banner - FIXED -->
    <div class="permission-banner" id="permissionBanner">
        <div>🎤 Microphone access needed for speech recognition</div>
        <div style="margin-top: 0.5rem;">
            <button class="permission-btn" onclick="requestMicrophonePermission()">Allow Microphone</button>
            <button class="permission-btn" onclick="dismissPermissionBanner()">Maybe Later</button>
        </div>
    </div>

    <div class="container">
        <!-- Minimal Header -->
        <header class="header">
            <h1>🎯 PolyglotVoice</h1>
            <div class="header-subtitle">Mobile Speech Platform</div>
        </header>

        <main class="main-content">
            <!-- PRIMARY: Text-to-Speech Section -->
            <section class="card tts-section">
                <div class="card-header">
                    <span class="card-icon">🔊</span>
                    <h2 class="card-title">Read Text Aloud</h2>
                </div>

                <!-- Quick Paste Actions -->
                <div class="quick-actions">
                    <button class="quick-btn" onclick="pasteFromClipboard()">📋 Paste</button>
                    <button class="quick-btn" onclick="clearText()">🗑️ Clear</button>
                    <button class="quick-btn" onclick="copyText()">📄 Copy</button>
                    <button class="quick-btn" onclick="testVoice()">👂 Test</button>
                </div>

                <!-- Main Text Input -->
                <textarea 
                    class="text-area" 
                    id="mainTextInput"
                    placeholder="Copy and paste your text here, or type directly. This will be read aloud with your selected voice..."
                    autocomplete="off"></textarea>

                <!-- Primary Read Button -->
                <button class="primary-btn" id="readButton" onclick="readTextAloud()">
                    <span id="readIcon">🔊</span>
                    <span id="readText">Read Aloud</span>
                </button>

                <!-- Status -->
                <div class="status status-info" id="ttsStatus">
                    📱 Ready to read your text aloud
                </div>
            </section>

            <!-- SECONDARY: Speech-to-Text Section -->
            <section class="card stt-section">
                <div class="card-header">
                    <span class="card-icon">🎤</span>
                    <h2 class="card-title">Voice Recording</h2>
                </div>

                <!-- Record Button -->
                <button class="primary-btn" id="recordButton" onclick="toggleRecording()">
                    <span id="recordIcon">🎤</span>
                    <span id="recordText">Start Recording</span>
                </button>

                <!-- Audio Visualizer -->
                <div class="visualizer" id="audioVisualizer">
                    <div class="audio-bars">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <div>🎤 Listening...</div>
                </div>

                <!-- Transcript Output -->
                <textarea 
                    class="text-area" 
                    id="transcriptOutput"
                    placeholder="Your speech will be transcribed here..."
                    readonly></textarea>

                <!-- STT Actions -->
                <div class="quick-actions">
                    <button class="quick-btn" onclick="clearTranscript()">🗑️ Clear</button>
                    <button class="quick-btn" onclick="copyTranscript()">📋 Copy</button>
                    <button class="quick-btn" onclick="moveToTTS()">⬆️ Move Up</button>
                    <button class="quick-btn" onclick="exportTranscript()">💾 Export</button>
                </div>

                <!-- STT Status -->
                <div class="status status-info" id="sttStatus">
                    🎤 Ready to record your voice
                </div>
            </section>

            <!-- BOTTOM: Voice Controls -->
            <section class="card voice-section">
                <div class="card-header">
                    <span class="card-icon">🎭</span>
                    <h2 class="card-title">Voice Settings</h2>
                </div>

                <!-- Language Selection -->
                <select class="voice-select" id="voiceLanguage">
                    <optgroup label="🇬🇧 English (UK)">
                        <option value="en-GB" selected>🇬🇧 English (UK)</option>
                        <option value="en-GB-scotland">🏴󠁧󠁢󠁳󠁣󠁴󠁿 Scottish English</option>
                        <option value="en-GB-wales">🏴󠁧󠁢󠁷󠁬󠁳󠁿 Welsh English</option>
                        <option value="en-GB-ireland">🇮🇪 Irish English</option>
                    </optgroup>
                    <optgroup label="🇺🇸 English (US)">
                        <option value="en-US">🇺🇸 English (US)</option>
                        <option value="en-US-california">🌴 California English</option>
                        <option value="en-US-texas">🤠 Texas English</option>
                        <option value="en-US-newyork">🗽 New York English</option>
                    </optgroup>
                    <optgroup label="🌍 Other Languages">
                        <option value="es-ES">🇪🇸 Spanish</option>
                        <option value="fr-FR">🇫🇷 French</option>
                        <option value="de-DE">🇩🇪 German</option>
                        <option value="ja-JP">🇯🇵 Japanese</option>
                    </optgroup>
                </select>

                <!-- Voice Selection -->
                <select class="voice-select" id="voiceSelect">
                    <option value="">🔄 Loading voices...</option>
                </select>

                <!-- Voice Information -->
                <div class="voice-info" id="voiceInfo">
                    🔄 Select a voice to see details...
                </div>

                <!-- Advanced Controls Toggle -->
                <button class="advanced-toggle" onclick="toggleAdvancedControls()">
                    ⚙️ Advanced Controls <span id="advancedIndicator">▼</span>
                </button>

                <div class="advanced-controls" id="advancedControls">
                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Speech Rate</span>
                            <span class="slider-value" id="rateValue">1.0x</span>
                        </div>
                        <input type="range" class="range-slider" id="speechRate" 
                            min="0.5" max="2.0" value="1.0" step="0.1">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Pitch</span>
                            <span class="slider-value" id="pitchValue">1.0</span>
                        </div>
                        <input type="range" class="range-slider" id="speechPitch" 
                            min="0.5" max="2.0" value="1.0" step="0.1">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <span class="slider-label">Volume</span>
                            <span class="slider-value" id="volumeValue">100%</span>
                        </div>
                        <input type="range" class="range-slider" id="speechVolume" 
                            min="0" max="100" value="100" step="5">
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global Variables
        let currentUtterance = null;
        let recognition = null;
        let isRecording = false;
        let isSpeaking = false;
        let availableVoices = [];
        let advancedControlsExpanded = false;
        let microphonePermissionGranted = false;
        let voicesLoaded = false;
        let permissionPersistenceKey = 'polyglot-mic-granted-v2';
        let preferredVoiceKey = 'polyglot-preferred-voice-v2';
        let sessionPermissionGranted = false;
        let targetVoiceName = 'Microsoft George - English (United Kingdom)';

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 PolyglotVoice initializing...');
            
            // Check stored permissions first (aggressive)
            checkStoredPermissions();
            
            // Initialize in order
            initializeVoices();
            initializeSliders();
            setupMobileOptimizations();
            
            // Microphone setup
            if (microphonePermissionGranted || sessionPermissionGranted) {
                console.log('✅ Using stored microphone permission');
                initializeSpeechRecognition();
                updateSTTStatus('✅ Microphone ready (stored)', 'success');
            } else {
                console.log('🎤 No stored permission, will check on first use');
                updateSTTStatus('🎤 Click record to start', 'info');
                // Try to get permission immediately but silently
                setTimeout(checkMicrophonePermission, 500);
            }
            
            console.log('✅ PolyglotVoice ready!');
        });

        // AGGRESSIVE PERMISSION STORAGE
        function checkStoredPermissions() {
            // Check multiple storage methods
            const stored1 = localStorage.getItem(permissionPersistenceKey);
            const stored2 = sessionStorage.getItem(permissionPersistenceKey);
            const stored3 = localStorage.getItem('mic-permission-backup');
            
            if (stored1 === 'true' || stored2 === 'true' || stored3 === 'true' || sessionPermissionGranted) {
                microphonePermissionGranted = true;
                sessionPermissionGranted = true;
                console.log('✅ Using stored microphone permission');
                return true;
            }
            return false;
        }

        function storePermissionGrant() {
            // Store in multiple places for redundancy
            localStorage.setItem(permissionPersistenceKey, 'true');
            sessionStorage.setItem(permissionPersistenceKey, 'true');
            localStorage.setItem('mic-permission-backup', 'true');
            sessionPermissionGranted = true;
            microphonePermissionGranted = true;
            console.log('💾 Microphone permission stored (multiple locations)');
        }

        function clearStoredPermissions() {
            localStorage.removeItem(permissionPersistenceKey);
            sessionStorage.removeItem(permissionPersistenceKey);
            localStorage.removeItem('mic-permission-backup');
            sessionPermissionGranted = false;
            console.log('🗑️ All stored permissions cleared');
        }

        // FIXED: Robust Voice Loading System
        function initializeVoices() {
            console.log('🔄 Starting voice initialization...');
            
            function loadVoices() {
                availableVoices = speechSynthesis.getVoices();
                console.log(`Found ${availableVoices.length} voices`);
                
                if (availableVoices.length > 0) {
                    voicesLoaded = true;
                    console.log('✅ Voices loaded successfully');
                    updateVoiceOptions();
                    setupVoiceEventListeners();
                } else if (!voicesLoaded) {
                    // Fallback mode
                    console.log('⚠️ No voices found, using fallback');
                    createFallbackVoices();
                }
            }
            
            function createFallbackVoices() {
                const voiceSelect = document.getElementById('voiceSelect');
                voiceSelect.innerHTML = `
                    <option value="default" selected>🔊 Default System Voice</option>
                    <option value="fallback">🎭 Browser Fallback</option>
                `;
                
                const voiceInfo = document.getElementById('voiceInfo');
                voiceInfo.innerHTML = `
                    <div><strong>Voice:</strong> System Default</div>
                    <div><strong>Language:</strong> Auto-detect</div>
                    <div><strong>Status:</strong> Ready to speak</div>
                `;
                
                voicesLoaded = true;
                setupVoiceEventListeners();
            }
            
            // Multiple loading strategies
            speechSynthesis.addEventListener('voiceschanged', loadVoices);
            
            // Immediate attempts
            setTimeout(loadVoices, 50);
            setTimeout(loadVoices, 200);
            setTimeout(loadVoices, 500);
            setTimeout(loadVoices, 1000);
            
            // User interaction trigger
            document.addEventListener('click', loadVoices, { once: true });
            
            // Fallback after 3 seconds
            setTimeout(() => {
                if (!voicesLoaded) {
                    console.log('⏰ Voice loading timeout, using fallback');
                    createFallbackVoices();
                }
            }, 3000);
        }

        function updateVoiceOptions() {
            const voiceSelect = document.getElementById('voiceSelect');
            const selectedLang = document.getElementById('voiceLanguage').value;
            
            voiceSelect.innerHTML = '';
            
            // Filter voices by language
            const baseLang = selectedLang.split('-')[0];
            let filteredVoices = availableVoices.filter(voice => {
                const voiceLang = voice.lang.toLowerCase();
                const selectedLangLower = selectedLang.toLowerCase();
                
                return voiceLang === selectedLangLower || 
                       voiceLang.startsWith(baseLang) ||
                       voiceLang.includes(selectedLangLower);
            });
            
            // Fallback to all voices if no matches
            if (filteredVoices.length === 0) {
                filteredVoices = availableVoices.filter(voice => 
                    voice.lang.toLowerCase().startsWith(baseLang)
                );
            }
            
            if (filteredVoices.length === 0) {
                filteredVoices = availableVoices;
            }
            
            // FIXED: Prioritize Microsoft George
            let georgeVoiceIndex = -1;
            let defaultVoiceIndex = -1;
            let preferredVoiceIndex = -1;
            
            // Check for stored preference
            const storedVoice = localStorage.getItem(preferredVoiceKey);
            
            // Populate select options and find Microsoft George
            filteredVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                const flag = getLanguageFlag(voice.lang);
                const name = voice.name.length > 25 ? voice.name.substring(0, 25) + '...' : voice.name;
                option.textContent = `${flag} ${name}`;
                
                // Find Microsoft George specifically
                if (voice.name.includes('Microsoft George') || 
                    voice.name.includes('George') && voice.name.includes('Microsoft') ||
                    voice.name === targetVoiceName) {
                    georgeVoiceIndex = index;
                    console.log(`🎯 Found Microsoft George at index ${index}: ${voice.name}`);
                }
                
                // Find system default voice
                if (voice.default || voice.name.toLowerCase().includes('default')) {
                    defaultVoiceIndex = index;
                }
                
                // Find stored preferred voice
                if (storedVoice && voice.name === storedVoice) {
                    preferredVoiceIndex = index;
                }
                
                voiceSelect.appendChild(option);
            });
            
            // SELECTION PRIORITY: Microsoft George > Stored Preference > System Default > First Available
            if (georgeVoiceIndex >= 0) {
                voiceSelect.selectedIndex = georgeVoiceIndex;
                localStorage.setItem(preferredVoiceKey, filteredVoices[georgeVoiceIndex].name);
                console.log(`🎭 DEFAULTED TO Microsoft George: ${filteredVoices[georgeVoiceIndex].name}`);
            } else if (preferredVoiceIndex >= 0) {
                voiceSelect.selectedIndex = preferredVoiceIndex;
                console.log(`🎭 Using stored preferred voice: ${filteredVoices[preferredVoiceIndex].name}`);
            } else if (defaultVoiceIndex >= 0) {
                voiceSelect.selectedIndex = defaultVoiceIndex;
                console.log(`🔊 Using system default voice: ${filteredVoices[defaultVoiceIndex].name}`);
            } else {
                voiceSelect.selectedIndex = 0;
                console.log(`📢 Using first available voice: ${filteredVoices[0]?.name}`);
            }
            
            // Update voice info immediately
            updateVoiceInfo();
        }

        function getLanguageFlag(lang) {
            const flags = {
                'en-GB': '🇬🇧', 'en-US': '🇺🇸', 'en-AU': '🇦🇺', 'en-CA': '🇨🇦',
                'es-ES': '🇪🇸', 'es-MX': '🇲🇽', 'fr-FR': '🇫🇷', 'fr-CA': '🇨🇦',
                'de-DE': '🇩🇪', 'ja-JP': '🇯🇵', 'zh-CN': '🇨🇳', 'ko-KR': '🇰🇷',
                'it-IT': '🇮🇹', 'pt-BR': '🇧🇷', 'ru-RU': '🇷🇺', 'ar-SA': '🇸🇦'
            };
            return flags[lang] || '🔊';
        }

        function updateVoiceInfo() {
            const voiceSelect = document.getElementById('voiceSelect');
            const voiceInfo = document.getElementById('voiceInfo');
            const selectedIndex = voiceSelect.value;
            
            if (selectedIndex === '' || selectedIndex === 'default' || selectedIndex === 'fallback') {
                voiceInfo.innerHTML = `
                    <div><strong>Voice:</strong> System Default</div>
                    <div><strong>Language:</strong> Auto-detect</div>
                    <div><strong>Status:</strong> Ready to speak</div>
                `;
                return;
            }
            
            const selectedVoice = availableVoices[selectedIndex];
            if (selectedVoice) {
                voiceInfo.innerHTML = `
                    <div><strong>Voice:</strong> ${selectedVoice.name}</div>
                    <div><strong>Language:</strong> ${selectedVoice.lang}</div>
                    <div><strong>Type:</strong> ${selectedVoice.localService ? 'Local' : 'Online'}</div>
                    <div><strong>Status:</strong> ${selectedVoice.default ? 'Default' : 'Available'}</div>
                `;
            }
        }

        function setupVoiceEventListeners() {
            const voiceLanguage = document.getElementById('voiceLanguage');
            const voiceSelect = document.getElementById('voiceSelect');
            
            voiceLanguage.addEventListener('change', updateVoiceOptions);
            voiceSelect.addEventListener('change', () => {
                updateVoiceInfo();
                // Store voice preference
                const selectedIndex = voiceSelect.selectedIndex;
                if (selectedIndex >= 0 && availableVoices[selectedIndex]) {
                    localStorage.setItem(preferredVoiceKey, availableVoices[selectedIndex].name);
                    console.log(`💾 Saved voice preference: ${availableVoices[selectedIndex].name}`);
                }
            });
            
            console.log('✅ Voice event listeners set up');
        }

        // AGGRESSIVE MICROPHONE PERMISSION MANAGEMENT
        async function checkMicrophonePermission() {
            // Skip if already granted in this session
            if (microphonePermissionGranted || sessionPermissionGranted) {
                console.log('✅ Microphone already granted in session');
                return;
            }
            
            try {
                // Try to access microphone directly first
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('✅ Microphone access granted automatically');
                stream.getTracks().forEach(track => track.stop());
                microphonePermissionGranted = true;
                sessionPermissionGranted = true;
                storePermissionGrant();
                initializeSpeechRecognition();
                updateSTTStatus('✅ Microphone ready', 'success');
                return;
            } catch (silentError) {
                // Permissions API fallback
                try {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    
                    if (result.state === 'granted') {
                        microphonePermissionGranted = true;
                        sessionPermissionGranted = true;
                        storePermissionGrant();
                        initializeSpeechRecognition();
                        updateSTTStatus('✅ Microphone ready', 'success');
                    } else if (result.state === 'denied') {
                        updateSTTStatus('❌ Microphone access denied', 'error');
                    } else {
                        updateSTTStatus('🎤 Click record to request microphone access', 'info');
                    }
                } catch (error) {
                    console.log('Permission API not available, will request on first use');
                    updateSTTStatus('🎤 Click record to request microphone access', 'info');
                }
            }
        }

        async function requestMicrophonePermission() {
            console.log('🎤 Requesting microphone permission (aggressive mode)...');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                microphonePermissionGranted = true;
                sessionPermissionGranted = true;
                storePermissionGrant();
                dismissPermissionBanner();
                
                // Stop the stream immediately
                stream.getTracks().forEach(track => track.stop());
                
                initializeSpeechRecognition();
                updateSTTStatus('✅ Microphone permission granted', 'success');
                
                console.log('✅ Microphone permission successfully granted and stored');
                return true;
                
            } catch (error) {
                console.error('Microphone permission denied:', error);
                dismissPermissionBanner();
                updateSTTStatus('❌ Microphone permission denied', 'error');
                
                // Clear any stale permissions
                clearStoredPermissions();
                microphonePermissionGranted = false;
                sessionPermissionGranted = false;
                
                return false;
            }
        }

        function dismissPermissionBanner() {
            const banner = document.getElementById('permissionBanner');
            banner.classList.remove('show');
        }

        // Speech Recognition Setup
        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateSTTStatus('❌ Speech recognition not supported', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = document.getElementById('voiceLanguage').value || 'en-GB';
            
            recognition.onstart = () => {
                console.log('🎤 Recording started');
                showAudioVisualizer();
                updateSTTStatus('🎤 Listening...', 'info');
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const transcriptOutput = document.getElementById('transcriptOutput');
                const currentText = transcriptOutput.value;
                
                if (finalTranscript) {
                    transcriptOutput.value = currentText + finalTranscript + ' ';
                    updateSTTStatus('✅ Text captured', 'success');
                }
                
                // Show interim results
                if (interimTranscript) {
                    updateSTTStatus(`🎤 ${interimTranscript}...`, 'info');
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                updateSTTStatus(`❌ Error: ${event.error}`, 'error');
                stopRecording();
            };
            
            recognition.onend = () => {
                console.log('🛑 Recording ended');
                hideAudioVisualizer();
                if (isRecording) {
                    updateSTTStatus('🎤 Ready to record', 'info');
                }
                isRecording = false;
                updateRecordButton();
            };
        }

        // Text-to-Speech Functions
        function readTextAloud() {
            const text = document.getElementById('mainTextInput').value.trim();
            
            if (!text) {
                updateTTSStatus('⚠️ Please enter some text to read', 'error');
                return;
            }
            
            if (isSpeaking) {
                stopSpeaking();
                return;
            }
            
            speak(text);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                currentUtterance = new SpeechSynthesisUtterance(text);
                
                // FIXED: Set voice correctly
                const voiceSelect = document.getElementById('voiceSelect');
                const selectedIndex = parseInt(voiceSelect.value);
                
                if (!isNaN(selectedIndex) && selectedIndex >= 0 && availableVoices[selectedIndex]) {
                    currentUtterance.voice = availableVoices[selectedIndex];
                    console.log(`🎭 Speaking with: ${availableVoices[selectedIndex].name}`);
                } else {
                    // Use system default
                    const defaultVoice = availableVoices.find(voice => voice.default);
                    if (defaultVoice) {
                        currentUtterance.voice = defaultVoice;
                        console.log(`🔊 Using system default: ${defaultVoice.name}`);
                    } else {
                        console.log('🔊 Using browser default voice');
                    }
                }
                
                // Set parameters
                currentUtterance.rate = parseFloat(document.getElementById('speechRate').value);
                currentUtterance.pitch = parseFloat(document.getElementById('speechPitch').value);
                currentUtterance.volume = parseFloat(document.getElementById('speechVolume').value) / 100;
                
                currentUtterance.onstart = () => {
                    isSpeaking = true;
                    updateReadButton();
                    updateTTSStatus('🔊 Speaking...', 'info');
                };
                
                currentUtterance.onend = () => {
                    isSpeaking = false;
                    updateReadButton();
                    updateTTSStatus('✅ Finished speaking', 'success');
                };
                
                currentUtterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event);
                    isSpeaking = false;
                    updateReadButton();
                    updateTTSStatus('❌ Error speaking text', 'error');
                };
                
                speechSynthesis.speak(currentUtterance);
            } else {
                updateTTSStatus('❌ Speech synthesis not supported', 'error');
            }
        }

        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            isSpeaking = false;
            updateReadButton();
            updateTTSStatus('🛑 Stopped speaking', 'info');
        }

        // Recording Functions
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            console.log('🎤 Start recording requested...');
            
            // AGGRESSIVE PERMISSION CHECK
            if (!microphonePermissionGranted && !sessionPermissionGranted) {
                console.log('🎤 No stored permission, requesting now...');
                const granted = await requestMicrophonePermission();
                if (!granted) {
                    console.log('❌ Permission denied, showing banner');
                    showPermissionBanner();
                    return;
                }
            }
            
            // Double-check we have recognition initialized
            if (!recognition) {
                console.log('🎤 Initializing speech recognition...');
                initializeSpeechRecognition();
                if (!recognition) {
                    console.log('❌ Failed to initialize speech recognition');
                    return;
                }
            }
            
            try {
                // Set language and start
                recognition.lang = document.getElementById('voiceLanguage').value || 'en-GB';
                console.log(`🎤 Starting recognition with language: ${recognition.lang}`);
                
                recognition.start();
                isRecording = true;
                updateRecordButton();
                
                console.log('✅ Recording started successfully');
                
            } catch (error) {
                console.error('Failed to start recording:', error);
                updateSTTStatus('❌ Failed to start recording', 'error');
                
                // If error might be permission-related, clear stored permission and retry
                if (error.name === 'NotAllowedError') {
                    console.log('🔄 Permission error detected, clearing cache and retrying...');
                    clearStoredPermissions();
                    microphonePermissionGranted = false;
                    sessionPermissionGranted = false;
                    
                    // Try once more
                    setTimeout(async () => {
                        const granted = await requestMicrophonePermission();
                        if (granted) {
                            try {
                                recognition.start();
                                isRecording = true;
                                updateRecordButton();
                            } catch (retryError) {
                                console.error('Retry failed:', retryError);
                            }
                        }
                    }, 1000);
                }
            }
        }

        function showPermissionBanner() {
            // Only show if not already handled
            if (!microphonePermissionGranted && !sessionPermissionGranted) {
                const banner = document.getElementById('permissionBanner');
                banner.classList.add('show');
            }
        }

        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            isRecording = false;
            updateRecordButton();
            hideAudioVisualizer();
        }

        // UI Update Functions
        function updateReadButton() {
            const button = document.getElementById('readButton');
            const icon = document.getElementById('readIcon');
            const text = document.getElementById('readText');
            
            if (isSpeaking) {
                button.classList.add('active');
                icon.textContent = '🛑';
                text.textContent = 'Stop Speaking';
            } else {
                button.classList.remove('active');
                icon.textContent = '🔊';
                text.textContent = 'Read Aloud';
            }
        }

        function updateRecordButton() {
            const button = document.getElementById('recordButton');
            const icon = document.getElementById('recordIcon');
            const text = document.getElementById('recordText');
            
            if (isRecording) {
                button.classList.add('recording');
                icon.textContent = '🛑';
                text.textContent = 'Stop Recording';
            } else {
                button.classList.remove('recording');
                icon.textContent = '🎤';
                text.textContent = 'Start Recording';
            }
        }

        function updateTTSStatus(message, type = 'info') {
            const status = document.getElementById('ttsStatus');
            status.textContent = message;
            status.className = `status status-${type}`;
        }

        function updateSTTStatus(message, type = 'info') {
            const status = document.getElementById('sttStatus');
            status.textContent = message;
            status.className = `status status-${type}`;
        }

        function showAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.classList.add('active');
        }

        function hideAudioVisualizer() {
            const visualizer = document.getElementById('audioVisualizer');
            visualizer.classList.remove('active');
        }

        // Quick Action Functions
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('mainTextInput').value = text;
                updateTTSStatus('📋 Text pasted from clipboard', 'success');
            } catch (error) {
                updateTTSStatus('❌ Failed to paste from clipboard', 'error');
            }
        }

        function clearText() {
            document.getElementById('mainTextInput').value = '';
            updateTTSStatus('🗑️ Text cleared', 'info');
        }

        async function copyText() {
            const text = document.getElementById('mainTextInput').value;
            if (text) {
                try {
                    await navigator.clipboard.writeText(text);
                    updateTTSStatus('📄 Text copied to clipboard', 'success');
                } catch (error) {
                    updateTTSStatus('❌ Failed to copy text', 'error');
                }
            }
        }

        function testVoice() {
            const testText = "Hello! This is a test of the selected voice. How does it sound?";
            speak(testText);
        }

        function clearTranscript() {
            document.getElementById('transcriptOutput').value = '';
            updateSTTStatus('🗑️ Transcript cleared', 'info');
        }

        async function copyTranscript() {
            const text = document.getElementById('transcriptOutput').value;
            if (text) {
                try {
                    await navigator.clipboard.writeText(text);
                    updateSTTStatus('📋 Transcript copied', 'success');
                } catch (error) {
                    updateSTTStatus('❌ Failed to copy transcript', 'error');
                }
            }
        }

        function moveToTTS() {
            const transcript = document.getElementById('transcriptOutput').value;
            if (transcript) {
                document.getElementById('mainTextInput').value = transcript;
                updateTTSStatus('⬆️ Transcript moved to text area', 'success');
            }
        }

        function exportTranscript() {
            const text = document.getElementById('transcriptOutput').value;
            if (text) {
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcript-${new Date().toISOString().slice(0, 10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                updateSTTStatus('💾 Transcript exported', 'success');
            }
        }

        // Advanced Controls
        function toggleAdvancedControls() {
            const controls = document.getElementById('advancedControls');
            const indicator = document.getElementById('advancedIndicator');
            
            advancedControlsExpanded = !advancedControlsExpanded;
            
            if (advancedControlsExpanded) {
                controls.classList.add('expanded');
                indicator.textContent = '▲';
            } else {
                controls.classList.remove('expanded');
                indicator.textContent = '▼';
            }
        }

        function initializeSliders() {
            const speechRate = document.getElementById('speechRate');
            const speechPitch = document.getElementById('speechPitch');
            const speechVolume = document.getElementById('speechVolume');
            
            speechRate.addEventListener('input', (e) => {
                document.getElementById('rateValue').textContent = e.target.value + 'x';
            });
            
            speechPitch.addEventListener('input', (e) => {
                document.getElementById('pitchValue').textContent = e.target.value;
            });
            
            speechVolume.addEventListener('input', (e) => {
                document.getElementById('volumeValue').textContent = e.target.value + '%';
            });
        }

        // Mobile Optimizations
        function setupMobileOptimizations() {
            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    if (window.innerWidth < 768) {
                        document.querySelector('meta[name=viewport]').setAttribute(
                            'content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'
                        );
                    }
                });
                
                input.addEventListener('blur', () => {
                    document.querySelector('meta[name=viewport]').setAttribute(
                        'content', 'width=device-width, initial-scale=1.0, user-scalable=no'
                    );
                });
            });
            
            // Handle orientation changes
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    window.scrollTo(0, 0);
                }, 100);
            });
        }

        // Error Handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 'Enter':
                        event.preventDefault();
                        readTextAloud();
                        break;
                    case 'r':
                        event.preventDefault();
                        toggleRecording();
                        break;
                    case 'k':
                        event.preventDefault();
                        clearText();
                        break;
                }
            }
            
            // Escape to stop everything
            if (event.key === 'Escape') {
                stopSpeaking();
                stopRecording();
            }
        });

        console.log('🎯 PolyglotVoice loaded and ready!');
    </script>
</body>
</html>